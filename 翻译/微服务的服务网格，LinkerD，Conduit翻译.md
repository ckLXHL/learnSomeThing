# 【科普】服务于微服务的服务网格, LinkerD, 以及最新发布的 Conduit

原文链接：[Oliver Gould on Service Mesh for Microservices, LinkerD, and the Recently Released Conduit](https://www.infoq.com/podcasts/Oliver-Gould-microservices-linkerd-service-mesh?utm_source=infoqWeeklyNewsletter&utm_medium=WeeklyNL_EditorialContent_podcasts&utm_campaign=02132018news&utm_content=other)

>本文属于采访模式

Bouyant是LinkerD Service Mesh和最近发布的Conduit的开发公司。在播客中，Oliver(CTO)定义了服务网格，阐明了数据data plane和控制平面control plane的含义，讨论了服务网格可以为微服务应用程序所有者提供什么，最后讨论了他们开发Conduit的一些考虑。

## 关键要点

服务网格是处理服务间通信的专用基础设施。

服务网格有两个组件：数据平面data plane处理通信，控制平面关于策略和配置。

LinkerD和Conduit是由Bouyant开发的两个开放服务网格。

Conduit的内存占用空间小，并提供了一种通过配置来部署服务网格的方法。
 
 采用Rust（用于在Conduit中实现数据平面的语言）需要以不同方式认识内存，适应Rust的最佳方式是阅读其他人的代码。

 >听着像不像disf+dirpc

## Buoyant 的起步

* 10:30 我周五离开推特，周一就创立了这家公司
* 1:40 我非常喜欢我在推特和团队工作的技术。
* 1:45 从我在这家公司工作起，公司一直在变化，公司的员工从250人变成了2500人。
* 1:55 我个人在这里学到了很多东西，从编排到Mesos，再到容器化世界中的分布式系统。
* 2:10 我们认为我们学到了很多东西，并帮助那些在生产中遇到问题的人。


## 是什么让你想到这个点子?How has the vision evolved?

2:30 尽管我们在Twitter工作时使用的库非常牛逼，容易使用，但使用中还是有很多运维上的代码。

2:45 当我们发生事故时，我们通过改造库来纠正，以修复问题或使代码更加优雅.

2:55 在容器世界中，所有东西都基于网络运行，我认为这是一种运维上的价值。同时需要各种工具来维护这种价值

3:10 我们开始在代理中使用Finagle - 所以linkerd是一个很重但是允许团队能更快速的创新的代理.

## 什么是服务网格?

4:00 在微服务中，当你通过网络在服务之间进行通信时，它的运维变得很重要。

4:20 我将*服务网格*视为帮助你在运维层面上管理微服务的工具。

4:30 Twitter通过Finagle实现了一小部分服务网格，能够控制通信的某些方面。

4:40 我们在服务网格中可以看到，将所有运维代码从应用程序中取出，并放入代理层，在那里我们可以采用统一的方式处理流量。

## 像Finagle这样的库和服务网格有什么区别？

5:10 Netflix和Twitter这类大型公司能够决定如何编写软件，他们可以强制一种技术路线。

5:25 在一般的环境中，我们不能强加这一点，每个公司往往都拥有各种各样的技术栈。

5:30 技术栈很容易随时间而变化，因此需要在业务库之外解决通信运维这个问题。

6:00 将部署单元作为Kubernetes的pod，包含一组共同协作的服务，并且使用容器来包装，这种组合确实很具有吸引力。

## 服务网格有哪些工具？

6:20 去年，我会说Finagle，Hysterix，Linkerd和一些新项目：Istio，NGINX  - 看起来每个人都已经跳上了这个潮流。

7:20 他们都在做同样的事情 - 通过代理做一些额外的路由。

7:25 服务网格实际上是把一些额外的通信运维工作放在微服务中的每次调用之间。

7:30 在我们以前的架构中，我们没有那么多的服务 - 前端负载均衡，大型应用程序和数据库。

7:40 随着我们分解了这些庞然大物，通信开销增加了很多。

7:45 你可以用HAProxy和NGINX构建一个服务网格，并且我们已经和很多人讨论过了。

8:05 他们有一堆配置脚本或定制工具来帮助管理这些东西。

8:15 我们正在构建一个更加明确的服务网格API，以便你不需要手撸脚本。

> NGINX说是要做，但没看到行动

> 到这篇文章发表为止，istio并没有稳定可用，istio是google做得

> istio可能会牛逼，但是google吃相实在不好看

> 截止2月20日，github star，istio：6k；conduit：1k，linkerd：3.6k

## 需要使用服务网格的门槛是什么？

9:10 我们已经看到人们用linkerd进行生产，并且配置成百上千个linkerd，服务网格的使用已经不少了。

9:30 我们正在尝试去做的东西是渐进采用（incremental adoption），以使服务网格成为人们想要使用的东西。

9:55 我们专注于可观察性 - 服务是否正在运行，响应延迟是多少等等。

10:20 一旦你在公司中掌握了以上那些运维信息，你就可以在架构中开始增加更多的复杂的特性。

## 什么是管道，它与Linkerd有什么关系？

10:55 Linkerd是一个通用工具，这个工具让你进入了微服务的新世界。

11:20 将多种不同的开发运维环境拼接在一起非常棒。

11:30 对于包含多种环境的需求，服务网格带来极高的灵活性。

11:40 正如我们已经看到Kubernetes更多地被采用并在JVM中运行，有很多资源在侧挂进程（sidecar）中运行Linkerd。

> 断句比较奇怪，贴上原文：As we have seen more adoption of Kubernetes specifically and running in the JVM there are lots of resources running Linkerd in a sidecar process.

11:55 我们最小能够将Linkerd缩小到200M。

12:00 这对JVM来说很小，但对于demo来说可能相当大。

12:10 我们也看到Kubernetes更简单了，并且提供了API的原语，这意味着我们不必对环境进行抽象。

12:25 我们希望能构成一个与Kubernetes有更紧密集成的系统。

12:30 我们想同时解决资源成本的问题。

12:40 我们用Rust中重写了代理，并且有一个用Go编写的控制平面。

12:45 另一个重要的教训是，通过学习配置文件格式来开始使用这种软件是一种糟糕的方式 - 你只是想打开并运行。

13:00 在Conduit中，我们没有配置代理的配置文件 - 您只能与控制平面进行交互，控制平面是一组API。

13:10 在Kubernetes中启动它时，默认情况下会显示可见性和统计信息。

13:15 我们会在以后的设计中增加更多的灵活性。

## Conduit是开源软件吗？

13:25 Buoyant只做开源软件，所以是的。

13:30 Linkerd，namerd，conduit都是100％开源的。

## 已有的一套为Netflix服务的工具集 - 与conduit相同吗？

14:00 是的 - 随着时间的推移，我们会逐渐放宽支持应用程序的类型。

14:05 我们赞成惯例而不是配置 - 如果你以确定的方式做事，那么一定会有效果。但如果你想以不同的方式做，那么你可以重写。

## 现在conduit支持哪些通信协议？

14:20 现在，它包括gRPC，HTTP也是支持的协议。

14:30 我们将在未来的版本中提供通用的TCP协议支持。

## 如何安装？

14:50 使用kubectl apply来安装conduit controller。

15:00 它运行Prometheus获取遥测数据（telemetry data）。

15:10 您可以将conduit程序用侧挂方式运行，也可以在部署服务时时将其注入到服务的代理配置中。

15:30 conduit工作的方式是设置iptables路由，以便所有流量都通过代理，然后我们可以在线路上看到这些流量。

15:40 我们正在考虑增加对TLS的支持，所以我们可以为你包装TLS。

## 控制平面和数据平面之间有什么区别？

16:10 数据平面是您的服务之间的通信。

16:30 控制平面是我们放置所有策略和配置的一组服务或API。

16:35 控制平面将处理服务发现，路由规则，超时。

17:00 在Linkerd中，我们也有一个控制平面，它是namerd，一个路由管理进程和服务发现。

## 你为什么决定在Rust中实现数据平面和Go中的控制平面？

17:40 我们已经关注了Rust一段时间。

18:00 2015年，Rust社区非常小，当时的Rust甚至没有异步IO，这在代理中很重要。

18:10 快两年半过去了，Rust的网络库功能齐全。

18:30 现在是参与Rust的好时机，我们聘请了一大群Rust社区成员来帮助推动这一进程。

18:55 在使用Linkerd的过程中，我们发现人们将代码放入数据平面，这使得分析数据平面的性能变得更加困难。

19:05 我们希望人们能够做的是将策略添加到控制平面中，或者修改控制平面，Go可以使这一做法更容易。

19:25 让使用Golang的人更容易参与和贡献该项目。
> 确实像国内一篇文章上说的，表面上争当google的小三，暗地里憋大招挖墙脚

> linkerd使用scala开发的，说实话是挺难理解的。istio全部用go。conduit用go开发控制平面，Rust开发数据平面

## 当使用Rust开发时，你有什么发现？

20:15 Rust的borrow checker和内存模型非常不同。

20:20 我花了大约两个星期的时间来敲打我的头。

20:30 现在我用不同的方式思考程序 - 内存如何布置，执行流程是什么等等。

20:50 首先将我脑子里的模型转变为内存模型这种做法，改善了我的代码。

## Java开发人员如何在Rust程序中找到头绪？

10:30 我真的很喜欢Rust的类型系统。

10:30 避免在Rust中写OO（面向对象）并学会喜欢它的类型系统。

10:30 最好的方法是阅读其他人的代码。

10:30 另一大障碍是采用异步网络框架Tokyo。
> 这里应该是编者写错了，Tokyo应该是Tokio

10:30 网络框架也有自己的模型，就像notification模型一样。

10:30 配对编程和review是学习Rust的重要途径。

## 过去三年你在用户的角度对于服务网格学到了什么？

23:15 我们看到了采用服务网格的不同方法。

23:20 这个过程可能是渐进式的，例如那里有一个现有的巨型应用程序，而程序员正在从中分离出微型服务。

23:30 另一种方式是采用绿地模式（Greenfield），即在新的开发中不兼容老的方案。

24:00 渐进式方法通常取得更大的成功。

24:30 我们看到人们渴望功能，并尝试立即做所有事情。

24:50 作出这些决定的人通常不是最终用户。

## Conduit 是否支持 tracing？

26:00 这需要更改应用程序代码，我们不希望处于要求更改应用程序代码的位置。

26:15 我们最终会引入trace，但这不是优先功能。

26:20 我们还提供了一个轻触（tap）功能，可以让您实时查询并查看结果。

26:50 我们可以对符合特定模式的请求进行采样，并将结果发送到其他地方，而不必查看所有需要后续分析的对中央数据库的请求。

27:15 这是服务网格将来需要开发的工具，但我们首先关注当前。

## 因此，如果您有某种关联ID，那么您可以使用该功能跟踪到达的的请求？

27:40 是的，我们希望将来有这样现成的追踪功能。

27:50 它可能是这样的：如果你有这些headers，那么你可以自由的追踪。

28:20 你不应该事先知道你要问的问题。

28:30 如果你想知道从这个IP到这个路径的请求的状态码，你不需要添加日志并重新部署来回答这个问题。

## 延迟怎么样？

28:50 相对于JVM，native云原生是一个全新的世界。
>原文理解不够，贴上原文：Going native is a whole new world from a JVM

28:55 我们的P99s 不到毫秒。
> P99s是指什么，有人能指教一下吗

29:00 我们可能会因为一些测试而跌倒，但我们终将会达成目标。

## 开销怎么样

29:25 第一个改进是从100Mb的JVM转向2Mb的proxy。

30:05 在CPU方面我们还有更多的事情要做。

30:10 我们想成为一个小型侧挂（sidecar）代理。

## Linkerd发生了什么？

30:40 我们有Linkerd的支持合同，并继续开发。

30:45 但是我们并没有在功能开发上下更大的功夫。

31:00 由于Linkerd已投入生产，开发的焦点已经转移。

31:10 有了Conduit，我们更专注于控制平面。
> 这是准备和google的istio开战了，istio专注于控制平面，数据平面是Lyft做的

31:20 我想你会看到更多的功能开发者扑在Conduit上而不是Linkerd上。

# Conduit的发展路线图是什么样的？

31:30 在第二季度，我们专注于透明度并开发协议支持。

31:45 我们正在考虑安全性，默认建立身份识别和加密安全。

32:15 我们可以做的另一件事是让遥测更可靠。
> 附上原文：The other thing we can do is make the telemetry rock solid

32:20 我们需要给用户提供工具，以便我们只获取必须的数据。